# 4. Write OLAP Queries

> Use SQL to perform OLAP operations (Roll-up, Drill-down, Slice, Dice, Pivot) on a data warehouse built from a movie rental dataset.

---

## Dimension Tables

### Movie Dimension

```sql
CREATE TABLE DimMovie (
    MovieID INT PRIMARY KEY,
    Title VARCHAR(100),
    Genre VARCHAR(50),
    ReleaseYear INT
);
```

### Customer Dimension

```sql
CREATE TABLE DimCustomer (
    CustomerID INT PRIMARY KEY,
    Name VARCHAR(100),
    City VARCHAR(50),
    AgeGroup VARCHAR(20)
);
```

### Date Dimension

```sql
CREATE TABLE DimDate (
    DateID INT PRIMARY KEY,
    FullDate DATE,
    MonthName VARCHAR(20),
    Year INT,
    Quarter VARCHAR(10)
);
```

---

## Fact Table

### Rental Fact Table

```sql
CREATE TABLE FactRental (
    RentalID INT PRIMARY KEY,
    MovieID INT,
    CustomerID INT,
    DateID INT,
    RentalAmount DECIMAL(8,2),
    FOREIGN KEY (MovieID) REFERENCES DimMovie(MovieID),
    FOREIGN KEY (CustomerID) REFERENCES DimCustomer(CustomerID),
    FOREIGN KEY (DateID) REFERENCES DimDate(DateID)
);
```

---

## OLAP Operations with SQL

### 1. ROLL-UP

**Total rental amount rolled up by Genre â†’ Year**

```sql
SELECT 
    Genre, 
    Year, 
    SUM(RentalAmount) AS TotalRental
FROM FactRental F
JOIN DimMovie M ON F.MovieID = M.MovieID
JOIN DimDate D ON F.DateID = D.DateID
GROUP BY ROLLUP (Genre, Year);
```

### 2. DRILL-DOWN

**Drill down from Genre to specific Movies in 2025**

```sql
SELECT 
    Genre, 
    Title, 
    SUM(RentalAmount) AS TotalRental
FROM FactRental F
JOIN DimMovie M ON F.MovieID = M.MovieID
JOIN DimDate D ON F.DateID = D.DateID
WHERE D.Year = 2025
GROUP BY Genre, Title;
```

### 3. SLICE

**Slice the data for rentals made in 'Action' genre only**

```sql
SELECT 
    Title, 
    SUM(RentalAmount) AS TotalRental
FROM FactRental F
JOIN DimMovie M ON F.MovieID = M.MovieID
WHERE Genre = 'Action'
GROUP BY Title;
```

### 4. DICE

**Get rental amounts for 'Comedy' or 'Action' genres AND customers in the age group '18-25' during the year 2025**

```sql
SELECT 
    Genre, 
    AgeGroup, 
    Year,
    SUM(RentalAmount) AS TotalRental
FROM FactRental F
JOIN DimMovie M ON F.MovieID = M.MovieID
JOIN DimCustomer C ON F.CustomerID = C.CustomerID
JOIN DimDate D ON F.DateID = D.DateID
WHERE Genre IN ('Comedy', 'Action')
  AND AgeGroup = '18-25'
  AND Year = 2025
GROUP BY Genre, AgeGroup, Year;
```

### 5. PIVOT

**Pivot table: Total rental amount per Genre per Year**

#### SQL Server example using PIVOT operator

```sql
SELECT *
FROM (
    SELECT 
        Genre, 
        Year, 
        RentalAmount
    FROM FactRental F
    JOIN DimMovie M ON F.MovieID = M.MovieID
    JOIN DimDate D ON F.DateID = D.DateID
) AS SourceTable
PIVOT (
    SUM(RentalAmount)
    FOR Year IN ([2023], [2024], [2025])
) AS PivotTable;
```

#### For PostgreSQL or Oracle, use CASE WHEN style pivot:

```sql
SELECT 
    Genre,
    SUM(CASE WHEN Year = 2023 THEN RentalAmount ELSE 0 END) AS "2023",
    SUM(CASE WHEN Year = 2024 THEN RentalAmount ELSE 0 END) AS "2024",
    SUM(CASE WHEN Year = 2025 THEN RentalAmount ELSE 0 END) AS "2025"
FROM FactRental F
JOIN DimMovie M ON F.MovieID = M.MovieID
JOIN DimDate D ON F.DateID = D.DateID
GROUP BY Genre;
```
