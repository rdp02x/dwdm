# 13. Outlier Detection

> Identify outliers in a dataset using distance-based methods or Z-score analysis. Visualize the result using scatter plots.

---

## Python Implementation

### Import Libraries

```python
import numpy as np
import pandas as pd
import matplotlib.pyplot as plt
from sklearn.neighbors import NearestNeighbors
from scipy.stats import zscore
```

### Step 1: Create Synthetic Dataset

```python
np.random.seed(42)

# Generate normal cluster of points
x = np.random.normal(5, 1, 100)
y = np.random.normal(5, 1, 100)

# Add some clear outliers
x_outliers = np.random.uniform(10, 15, 5)
y_outliers = np.random.uniform(10, 15, 5)

# Combine data
x = np.concatenate([x, x_outliers])
y = np.concatenate([y, y_outliers])

data = pd.DataFrame({"x": x, "y": y})
print(data.head())
```

---

## Method 1: Z-Score Analysis

```python
# Compute z-scores for each column
z_scores = np.abs(zscore(data))

# Mark as outlier if z > 3
outliers_z = (z_scores > 3).any(axis=1)

print(f"Number of outliers detected (Z-score): {outliers_z.sum()}")
```

---

## Method 2: Distance-Based Outlier Detection (kNN)

```python
# Fit k-nearest neighbors
nbrs = NearestNeighbors(n_neighbors=5).fit(data)
distances, indices = nbrs.kneighbors(data)

# Mean distance to k nearest neighbors
mean_distances = distances.mean(axis=1)

# Top 5% distances = outliers
threshold = np.percentile(mean_distances, 95) 
outliers_dist = mean_distances > threshold

print(f"Number of outliers detected (Distance-based): {outliers_dist.sum()}")
```

---

## Visualization

```python
fig, axes = plt.subplots(1, 2, figsize=(12, 5))

# Z-score method plot
axes[0].scatter(data["x"], data["y"], c="blue", label="Normal", alpha=0.6)
axes[0].scatter(
    data[outliers_z]["x"], 
    data[outliers_z]["y"], 
    c="red", 
    label="Outliers", 
    s=100, 
    edgecolors='black'
)
axes[0].set_title("Outlier Detection using Z-Score")
axes[0].set_xlabel("X")
axes[0].set_ylabel("Y")
axes[0].legend()
axes[0].grid(True, alpha=0.3)

# Distance-based method plot
axes[1].scatter(data["x"], data["y"], c="blue", label="Normal", alpha=0.6)
axes[1].scatter(
    data[outliers_dist]["x"], 
    data[outliers_dist]["y"], 
    c="orange", 
    label="Outliers", 
    s=100, 
    edgecolors='black'
)
axes[1].set_title("Outlier Detection using Distance-Based Method")
axes[1].set_xlabel("X")
axes[1].set_ylabel("Y")
axes[1].legend()
axes[1].grid(True, alpha=0.3)

plt.tight_layout()
plt.show()
```

---

## Using IQR (Interquartile Range) Method

```python
def detect_outliers_iqr(df, column):
    Q1 = df[column].quantile(0.25)
    Q3 = df[column].quantile(0.75)
    IQR = Q3 - Q1
    
    lower_bound = Q1 - 1.5 * IQR
    upper_bound = Q3 + 1.5 * IQR
    
    outliers = (df[column] < lower_bound) | (df[column] > upper_bound)
    return outliers

# Detect outliers using IQR
outliers_iqr_x = detect_outliers_iqr(data, 'x')
outliers_iqr_y = detect_outliers_iqr(data, 'y')
outliers_iqr = outliers_iqr_x | outliers_iqr_y

print(f"Number of outliers detected (IQR): {outliers_iqr.sum()}")
```

### Visualize IQR Method

```python
plt.figure(figsize=(8, 6))
plt.scatter(data["x"], data["y"], c="blue", label="Normal", alpha=0.6)
plt.scatter(
    data[outliers_iqr]["x"], 
    data[outliers_iqr]["y"], 
    c="green", 
    label="Outliers (IQR)", 
    s=100, 
    edgecolors='black'
)
plt.title("Outlier Detection using IQR Method")
plt.xlabel("X")
plt.ylabel("Y")
plt.legend()
plt.grid(True, alpha=0.3)
plt.show()
```

---

## Summary

| **Method** | **Description** | **Best For** |
|------------|-----------------|-------------|
| **Z-Score** | Statistical method, threshold = 3 | Normally distributed data |
| **Distance-Based (kNN)** | Points far from neighbors | Non-normal distributions |
| **IQR** | Quartile-based outlier detection | Robust to extreme values |

### What This Does:
- Creates a dataset with a cluster + outliers.
- Detects outliers with:
  - **Z-score** (statistical method, threshold = 3)
  - **Distance-based (kNN)** (points far from neighbors are flagged)
  - **IQR** (Interquartile Range method)
- Visualizes all methods side-by-side using scatter plots.
