# 2. ETL Process Using SQL

> Perform an ETL (Extract, Transform, Load) process using sample sales data. Clean and transform the data before loading it into a warehouse.

---

## 1. Extract – Get Data from Source

Assume we have 3 raw CSV files:
1. `raw_sales.csv`
2. `raw_customers.csv`
3. `raw_products.csv`

### Sample content of `raw_sales.csv`:

```plaintext
sale_id	customer_name	product_name	quantity	price	date	store
1	John Doe	Laptop	1	50000	2024-12-01	Chennai
2	Jane Smith	Shampoo	4	250	2025-01-15	Mumbai
3	NULL	Laptop	1	50000	NULL	Chennai
```

---

## 2. Transform – Clean and Prepare Data

- Remove rows with NULLs in essential fields
- Convert date formats
- Remove duplicates
- Split data into dimensions
- Create surrogate keys

### Remove rows with nulls

```sql
CREATE TABLE Cleaned_Sales AS
SELECT * FROM Staging_Sales
WHERE customer_name IS NOT NULL
  AND product_name IS NOT NULL
  AND date IS NOT NULL;
```

### Remove duplicates

```sql
DELETE FROM Cleaned_Sales
WHERE sale_id NOT IN (
  SELECT MIN(sale_id)
  FROM Cleaned_Sales
  GROUP BY customer_name, product_name, date
);
```

### Format date

```sql
UPDATE Cleaned_Sales
SET date = STR_TO_DATE(date, '%Y-%m-%d');
```

---

## 3. Load – Insert into Data Warehouse Tables

Assume star schema tables already exist:
`Product_Dim`, `Customer_Dim`, `Store_Dim`, `Time_Dim`, `Sales_Fact`

---

### 3.1 Load Dimensions

#### Customer Dimension

```sql
INSERT INTO Customer_Dim (customer_id, customer_name, gender, age, city)
SELECT DISTINCT
       ROW_NUMBER() OVER () AS customer_id,
       customer_name,
       'F',
       30,
       'Mumbai'
FROM Cleaned_Sales;
```

#### Product Dimension

```sql
INSERT INTO Product_Dim (product_id, product_name, category, brand, price)
SELECT DISTINCT
       ROW_NUMBER() OVER () AS product_id,
       product_name,
       'Electronics',
       'DefaultBrand',
       price
FROM Cleaned_Sales;
```

#### Store Dimension

```sql
INSERT INTO Store_Dim (store_id, store_name, location, manager_name)
SELECT DISTINCT
       ROW_NUMBER() OVER () AS store_id,
       CONCAT('Store_', store),
       store,
       'Default Manager'
FROM Cleaned_Sales;
```

#### Time Dimension

```sql
INSERT INTO Time_Dim (time_id, date, month, quarter, year)
SELECT DISTINCT
       ROW_NUMBER() OVER () AS time_id,
       date,
       MONTHNAME(date),
       CONCAT('Q', QUARTER(date)),
       YEAR(date)
FROM Cleaned_Sales;
```

---

### 3.2 Load Fact Table

Join the dimensions using lookups and populate the fact table:

```sql
INSERT INTO Sales_Fact (sale_id, product_id, customer_id, store_id, time_id, quantity_sold, total_amount)
SELECT 
    s.sale_id,
    p.product_id,
    c.customer_id,
    st.store_id,
    t.time_id,
    s.quantity,
    s.quantity * s.price
FROM Cleaned_Sales s
JOIN Product_Dim p ON s.product_name = p.product_name
JOIN Customer_Dim c ON s.customer_name = c.customer_name
JOIN Store_Dim st ON s.store = st.location
JOIN Time_Dim t ON s.date = t.date;
```

